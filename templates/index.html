<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat with Server</title>
    <style>
        body { display: flex; flex-direction: column; height: 100vh; margin: 0; }
        #messages { flex-grow: 1; overflow-y: auto; padding: 10px; background: #f4f4f4; }
        #input-area { display: flex; padding: 10px; background: #ddd; }
        textarea { flex-grow: 1; margin-right: 10px; resize: none; height: 50px; }
        button { width: 100px; height: 50px; }
    </style>
</head>
<body>
    <div id="messages"></div>
    <div id="input-area">
        <textarea id="message" placeholder="Type here and press Enter to send" required></textarea>
        <button onclick="sendMessage()">Send</button>
    </div>
    <script>

        function generateRandomId(length) {
          let result = '';
          for (let i = 0; i < length; i++) {
            result += Math.floor(Math.random() * 10); // Generate a random digit and add to result
          }
          return result;
        }

        (function() {
          var id = localStorage.getItem("inside_the_castle_id");
          if (!id) {
            id = "user"+generateRandomId(7)
            localStorage.setItem("inside_the_castle_id", id);
          }
          window.user_id = id; // This sets a global variable `myGlobalId`
        })();
                
        document.addEventListener("DOMContentLoaded", function() {


            const textarea = document.getElementById("message");
            const button = document.querySelector("button");
            const msgArea = document.getElementById("messages");


             // Handshake with the server
             // send user id, get initial status
              fetch("/handshake", {
                method: "POST",
                headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'user_id=' + encodeURIComponent(user_id)
              })
              .then(response => response.json())
              .then(data => {
                if (data.error) {
                  console.error('Handshake error:', data.error);
                } else {
                  console.log('Handshake successful:', data.message);
                  msgArea.innerHTML += `<div><strong>Server:</strong> ${data.text}</div>`;
                  msgArea.scrollTop = msgArea.scrollHeight; // Scroll to bottom
                }
              })
              .catch(error => {
                console.error('Handshake Fetch Error:', error);
              });



            // Function to handle typical sending input/receving output messages
            function sendMessage() {
                const message = textarea.value.trim();
                if (!message) return; // Do nothing if the message is empty

                textarea.disabled = true; // Disable textarea during send
                button.disabled = true; // Disable button during send

                // Simulate sending the message
                fetch("/send_message", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'message=' + encodeURIComponent(message) + '&user_id=' + encodeURIComponent(user_id)
                        
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        alert(data.error);
                    } else {
                        msgArea.innerHTML += `<div><strong>You:</strong> ${message}</div>`;
                        msgArea.innerHTML += `<div><strong>Server:</strong> ${data.text}</div>`;
                        msgArea.scrollTop = msgArea.scrollHeight; // Scroll to bottom
                    }
                })
                .catch(error => {
                    console.error('Fetch Error:', error);
                    alert('An error occurred. Please check the console for details.');
                })
                .finally(() => {
                    textarea.disabled = false; // Re-enable textarea after response
                    button.disabled = false; // Re-enable button after response
                    textarea.value = ""; // Clear input after sending
                    textarea.focus(); // Focus textarea ready for next message
                });
            }

            // Listen for Enter key press to send message
            textarea.addEventListener("keydown", function(event) {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault(); // Prevent the default action (new line)
                    sendMessage(); // Call function to send message
                }
            });
        });
    </script>
</body>
</html>



