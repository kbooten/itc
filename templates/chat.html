<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat with Server</title>
    <style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: #fff;
        color: #000;
    }

    #header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background-color: #000;
        color: #fff;
        border-bottom: 2px dotted #fff;
        transform: skewY(-3deg) rotateZ(-2deg);
    }

    #header-left, #header-right {
        display: flex;
        align-items: center;
    }

    #header-left button, #header-right button {
        padding: 10px 20px;
        background-color: #fff;
        color: #000;
        border: 2px dotted #000;
        cursor: pointer;
        margin-left: 10px;
        transform: skewY(3deg) rotateZ(2deg);
    }

    #room-name {
        flex-grow: 1;
        text-align: center;
        transform: skewY(3deg) rotateZ(2deg);
    }

    #messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background-color: #fff;
        margin: 20px auto;
        width: 60%;
        max-width: 800px;
        border: 2px dotted #000;
        transform: skewY(-2deg) rotateZ(-1deg);
    }

    #messages div {
        margin-bottom: 15px;
        transform: rotate(calc(var(--rotation, 0deg)));
    }

    #input-area {
        display: flex;
        justify-content: center;
        padding: 10px;
        background-color: #000;
        transform: skewY(2deg) rotateZ(1deg);
    }

    #message {
        width: 60%;
        max-width: 800px;
        height: 50px;
        padding: 10px;
        border: 2px dotted #000;
        background-color: #fff;
        color: #000;
        transform: skewY(-2deg) rotateZ(-1deg);
    }

    #input-area button {
        margin-left: 10px;
        padding: 10px 20px;
        background-color: #fff;
        color: #000;
        border: 2px dotted #000;
        cursor: pointer;
        transform: skewY(-2deg) rotateZ(-1deg);
    }

    #popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) skewY(2deg) rotateZ(1deg);
        background-color: #fff;
        border: 2px dotted #000;
        width: 50%;
        max-width: 600px;
        z-index: 1000;
    }

    #popup-header {
        display: flex;
        justify-content: flex-end;
        padding: 10px;
        background-color: #000;
        color: #fff;
        border-bottom: 2px dotted #fff;
        transform: skewY(-2deg) rotateZ(-1deg);
    }

    #popup-header button {
        background-color: #fff;
        color: #000;
        border: 2px dotted #000;
        cursor: pointer;
        transform: skewY(2deg) rotateZ(1deg);
    }

    #popup-content {
        padding: 20px;
        transform: skewY(2deg) rotateZ(1deg);
    }

    /* Adding random rotations */
    #messages div:nth-child(odd) {
        --rotation: 1deg;
    }

    #messages div:nth-child(even) {
        --rotation: -1deg;
    }
    </style>
</head>
<body>
    <div id="header">
        <div id="header-left">
            <button id="back-button" onclick="goBack()">Back to Room Selection</button>
        </div>
        <div id="room-name">{{ room_info.author }}: {{ room_info.title }}</div>
        <div id="header-right">
            <button id="popup-button" onclick="openPopup()">Open Pop-up</button>
        </div>
    </div>
    <div id="messages"></div>
    <div id="input-area">
        <textarea id="message" placeholder="Type here and press Enter to send" required></textarea>
        <button onclick="sendMessage()">Send</button>
    </div>

    <!-- Pop-up structure -->
    <div id="popup">
        <div id="popup-header">
            <button onclick="closePopup()">Close</button>
        </div>
        <div id="popup-content"></div>
    </div>

    <script>
        let intermittentTimer;

        function goBack() {
            window.location.href = "{{ url_for('home') }}";
        }

        function openPopup() {
            const popup = document.getElementById('popup');
            const popupContent = document.getElementById('popup-content');
            const user_id = localStorage.getItem("inside_the_castle_id");
            
            if (!user_id) {
                alert('User ID not found. Please go back to the room selection.');
                return;
            }

            popup.style.display = 'block';

            // Fetch data from the backend
            fetch('/fetch_user_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'user_id=' + encodeURIComponent(user_id)
            })
            .then(response => response.text())
            .then(data => {
                popupContent.innerText = data;
            })
            .catch(error => {
                popupContent.innerText = 'Error fetching data';
                console.error('Error:', error);
            });
        }

        function closePopup() {
            document.getElementById('popup').style.display = 'none';
        }

        function startIntermittentTimer() {
            // Clear any existing timer
            clearTimeout(intermittentTimer);

            // Set a new timer with a random interval between 30 seconds (30000ms) and 3 minutes (180000ms)
            const interval = Math.random() * (180000 - 30000) + 30000;
            console.log(`Next intermittent request in ${interval} ms`);

            intermittentTimer = setTimeout(() => {
                sendIntervalMessage();
            }, interval);
        }

        function sendDefaultMessage() {
            const user_id = localStorage.getItem("inside_the_castle_id");
            if (!user_id) {
                console.error('User ID not found. Default message not sent.');
                return;
            }

            fetch("/send_message", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'message=' + encodeURIComponent("I look around") + '&user_id=' + encodeURIComponent(user_id) + '&room_id=' + encodeURIComponent("{{ room_info.id }}")
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    alert(data.error);
                } else {
                    const msgArea = document.getElementById("messages");
                    msgArea.innerHTML += `<div><strong>Room:</strong> ${data.text}</div>`;
                    msgArea.scrollTop = msgArea.scrollHeight; // Scroll to bottom
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                alert('An error occurred. Please check the console for details.');
            })
            .finally(() => {
                startIntermittentTimer(); // Start the intermittent timer after the default message
            });
        }

        function sendIntervalMessage() {
            const user_id = localStorage.getItem("inside_the_castle_id");
            if (!user_id) {
                console.error('User ID not found. Interval message not sent.');
                return;
            }

            fetch("/send_message", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'message=' + encodeURIComponent("[[time has passed]]") + '&user_id=' + encodeURIComponent(user_id) + '&room_id=' + encodeURIComponent("{{ room_info.id }}")
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    alert(data.error);
                } else {
                    const msgArea = document.getElementById("messages");
                    msgArea.innerHTML += `<div><strong>Server:</strong> ${data.text}</div>`;
                    msgArea.scrollTop = msgArea.scrollHeight; // Scroll to bottom
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                alert('An error occurred. Please check the console for details.');
            })
            .finally(() => {
                startIntermittentTimer(); // Reset the intermittent timer after the interval message
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            const textarea = document.getElementById("message");
            const button = document.querySelector("button");
            const msgArea = document.getElementById("messages");

            function sendMessage() {
                const message = textarea.value.trim();
                if (!message) return; // Do nothing if the message is empty

                const user_id = localStorage.getItem("inside_the_castle_id");
                if (!user_id) {
                    alert('User ID not found. Please go back to the room selection.');
                    return;
                }

                textarea.disabled = true; // Disable textarea during send
                button.disabled = true; // Disable button during send

                // Simulate sending the message
                fetch("/send_message", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'message=' + encodeURIComponent(message) + '&user_id=' + encodeURIComponent(user_id) + '&room_id=' + encodeURIComponent("{{ room_info.id }}")
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        alert(data.error);
                    } else {
                        msgArea.innerHTML += `<div><strong>You:</strong> ${message}</div>`;
                        msgArea.innerHTML += `<div><strong>Server:</strong> ${data.text}</div>`;
                        msgArea.scrollTop = msgArea.scrollHeight; // Scroll to bottom
                    }
                })
                .catch(error => {
                    console.error('Fetch Error:', error);
                    alert('An error occurred. Please check the console for details.');
                })
                .finally(() => {
                    textarea.disabled = false; // Re-enable textarea after response
                    button.disabled = false; // Re-enable button after response
                    textarea.value = ""; // Clear input after sending
                    textarea.focus(); // Focus textarea ready for next message
                    startIntermittentTimer(); // Reset the intermittent timer
                });
            }

            textarea.addEventListener("keydown", function(event) {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault(); // Prevent the default action (new line)
                    sendMessage(); // Call function to send message
                }
            });

            sendDefaultMessage(); // Send the default message when the page loads
        });
    </script>
</body>
</html>


