<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat with Server</title>
    <style>
        body { display: flex; flex-direction: column; height: 100vh; margin: 0; }
        #room-name { padding: 10px; background: #ccc; text-align: center; font-size: 1.5em; }
        #messages { flex-grow: 1; overflow-y: auto; padding: 10px; background: #f4f4f4; }
        #input-area { display: flex; padding: 10px; background: #ddd; }
        textarea { flex-grow: 1; margin-right: 10px; resize: none; height: 50px; }
        button { width: 100px; height: 50px; }
        #back-button { margin: 10px; }
    </style>
</head>
<body>
    <div id="room-name">Room: {{ room }}</div>
    <button id="back-button" onclick="goBack()">Back to Room Selection</button>
    <div id="messages"></div>
    <div id="input-area">
        <textarea id="message" placeholder="Type here and press Enter to send" required></textarea>
        <button onclick="sendMessage()">Send</button>
    </div>
    <script>
        function goBack() {
            window.location.href = "{{ url_for('home') }}";
        }

        document.addEventListener("DOMContentLoaded", function() {
            const textarea = document.getElementById("message");
            const button = document.querySelector("button");
            const msgArea = document.getElementById("messages");

            // Function to handle typical sending input/receiving output messages
            function sendMessage() {
                const message = textarea.value.trim();
                if (!message) return; // Do nothing if the message is empty

                const user_id = localStorage.getItem("inside_the_castle_id");
                if (!user_id) {
                    alert('User ID not found. Please go back to the room selection.');
                    return;
                }

                textarea.disabled = true; // Disable textarea during send
                button.disabled = true; // Disable button during send

                // Simulate sending the message
                fetch("/send_message", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'message=' + encodeURIComponent(message) + '&user_id=' + encodeURIComponent(user_id)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        alert(data.error);
                    } else {
                        msgArea.innerHTML += `<div><strong>You:</strong> ${message}</div>`;
                        msgArea.innerHTML += `<div><strong>Server:</strong> ${data.text}</div>`;
                        msgArea.scrollTop = msgArea.scrollHeight; // Scroll to bottom
                    }
                })
                .catch(error => {
                    console.error('Fetch Error:', error);
                    alert('An error occurred. Please check the console for details.');
                })
                .finally(() => {
                    textarea.disabled = false; // Re-enable textarea after response
                    button.disabled = false; // Re-enable button after response
                    textarea.value = ""; // Clear input after sending
                    textarea.focus(); // Focus textarea ready for next message
                });
            }

            // Listen for Enter key press to send message
            textarea.addEventListener("keydown", function(event) {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault(); // Prevent the default action (new line)
                    sendMessage(); // Call function to send message
                }
            });
        });
    </script>
</body>
</html>


